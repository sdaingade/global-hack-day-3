#!/bin/bash
# Author Swapnil Daingade, Sarjeet Singh
# Script to run inside container to configure maprfs

IP=$(ip addr show eth0 | grep -w inet | awk '{ print $2}' | cut -d "/" -f1)

echo -e "${IP}\t$(hostname -f)\t$(hostname -s) " >> /etc/hosts

mkdir -p /var/mapr
fallocate -l 20G /var/mapr/docker.disk
#dd if=/dev/zero of=/opt/mapr/docker.disk bs=1G count=5

/opt/mapr/server/mruuidgen > /opt/mapr/hostid
cat /opt/mapr/hostid > /opt/mapr/conf/hostid.$$

# Limit container memory to 8GB for mfs
cp /proc/meminfo /opt/mapr/conf/meminfofake
sed -i "/^MemTotal/ s/^.*$/MemTotal:     8388608 kB/" /opt/mapr/conf/meminfofake
sed -i "/^MemFree/ s/^.*$/MemFree:     8388592 kB/" /opt/mapr/conf/meminfofake
sed -i "/^MemAvailable/ s/^.*$/MemAvailable:     8388592 kB/" /opt/mapr/conf/meminfofake

sed -i 's/AddUdevRules(list/#AddUdevRules(list/' /opt/mapr/server/disksetup

# Add user & group for mapr.
addgroup --gid 500 mapr
adduser --uid 500 --ingroup mapr --disabled-password --gecos "" mapr

# TODO:work-around for zookeeper issue of not starting up.
#mkdir -p /opt/mapr/zkdata/version-2
#chown mapr.mapr /opt/mapr/zkdata/version-2

/opt/mapr/server/configure.sh -C ${RM_IP} -Z ${RM_IP} -D /var/mapr/docker.disk -RM ${RM_IP} --isvm

echo "This container IP : ${IP}"

while true
do
sleep 5
done
